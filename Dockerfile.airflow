FROM apache/airflow:2.9.1-python3.12

USER root
RUN apt-get update && apt-get install -y \
    default-libmysqlclient-dev \
    build-essential \
    netcat-openbsd \
    default-mysql-client \
    && rm -rf /var/lib/apt/lists/*

USER airflow
COPY requirements.txt /tmp/requirements.txt
RUN pip install -r /tmp/requirements.txt

# Copy Django project files
COPY --chown=airflow:root core/ /opt/airflow/core/
COPY --chown=airflow:root inventory/ /opt/airflow/inventory/
COPY --chown=airflow:root transactions/ /opt/airflow/transactions/
COPY --chown=airflow:root homepage/ /opt/airflow/homepage/
COPY --chown=airflow:root manage.py /opt/airflow/

# Set PYTHONPATH to include the Django project
ENV PYTHONPATH="/opt/airflow"

# Set default values for database connection
ENV DB_HOST=db
ENV DB_PORT=3306
ENV DB_NAME=inventory
ENV DB_USER=root
ENV DB_PASSWORD=root

# # Wait for database then keep container running for manual commands
# ENTRYPOINT ["/bin/bash", "-c", "\
# echo 'ğŸš€ Starting Airflow container...' && \
# echo 'â³ Waiting for MySQL database at ${DB_HOST}:${DB_PORT}...' && \
# until nc -z "$DB_HOST" "$DB_PORT" -e 'SELECT 1' >/dev/null 2>&1; do \
#   echo 'ğŸ”„ Database not ready, waiting 3 seconds...' && \
#   sleep 3; \
# done && \
# echo 'âœ… Database is ready!' && \
# echo 'ğŸ“¦ Running database migrations...' && \
# airflow db migrate && \
# echo 'âœ… Database migrations completed!' && \
# echo 'ğŸ¯ Container ready for manual Airflow commands' && \
# echo 'â„¹ï¸  Use: docker exec -it inventory-management-airflow-1 bash' && \
# sleep infinity"]

ENTRYPOINT ["/bin/bash", "-c", "\
echo 'ğŸš€ Starting Airflow container...' && \
echo 'â³ Waiting for MySQL database at ${DB_HOST}:${DB_PORT}...' && \
until nc -z -w 5 \"$DB_HOST\" \"$DB_PORT\"; do \
  echo \"ğŸ”„ Database not ready, waiting 5 seconds...\"; \
  sleep 5; \
done; \
echo 'âœ… Database is ready!'; \
echo 'ğŸ“¦ Running database migrations...'; \
airflow db migrate; \
echo 'âœ… Database migrations completed!'; \
echo 'ğŸ‘¤ Creating admin user if needed...'; \
airflow users create --username admin --password admin --firstname Admin --lastname User --role Admin --email admin@example.com || true; \
airflow webserver & airflow scheduler; \
echo 'â„¹ï¸  Use: docker exec -it inventory-management-airflow-1 bash'; \
tail -f /dev/null \
"]

